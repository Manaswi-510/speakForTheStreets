<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create - Speak for the Streets</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    :root {
      --primary-color: #111;
      --secondary-color: #fff;
      --accent-color: #2ecc71;
      --bg-color: #f0f2f5;
    }
    body.dark { --primary-color:#fff; --secondary-color:#111; --bg-color:#181818; }
    body { margin:0; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; background:var(--bg-color); color:var(--primary-color); }

    header { background:#000; padding:1rem; display:flex; justify-content:space-between; align-items:center; color:#fff; position:sticky; top:0; z-index:1000; }
    .location,.title { flex:1; } .location{text-align:left;} .title{text-align:center;font-weight:bold;}
    .header-right{display:flex;align-items:center;gap:1rem;}
    .language-switcher select{background:#000;color:white;border:1px solid #444;padding:4px 8px;border-radius:5px;cursor:pointer;}

    .sidebar { position:fixed; left:0; top:4rem; width:250px; height:calc(100% - 4rem); background:#000; color:white; display:flex; flex-direction:column; padding:1rem; gap:1rem; z-index:1500; overflow-y:auto; }
    .sidebar a{color:white;text-decoration:none;display:flex;align-items:center;gap:0.5rem;font-size:1.1rem;}

    .main-content{margin-left:260px;padding:2rem;}
    
    form{display:flex;flex-direction:column;gap:1rem;max-width:600px;}
    input,textarea,select{padding:10px;border:1px solid #ccc;border-radius:6px;}
    button{background:#2ecc71;color:white;border:none;padding:10px;border-radius:6px;cursor:pointer;font-weight:600;}
    button:hover{background:#27ae60;}
    button:disabled{background:#95a5a6;cursor:not-allowed;}
    
    .preview{margin-top:1rem;display:none;} 
    .preview img{max-width:100%;border-radius:10px;}
    
    .message { font-weight:500; margin-top:10px; padding:10px; border-radius:6px; }
    .message.success { color: #28a745; background:#d4edda; }
    .message.error { color: #dc3545; background:#f8d7da; }
    .message.warning { color: #856404; background:#fff3cd; }
    
    .geo-info {
      background: #e8f5e9;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }
    
    .geo-info.error {
      background: #ffebee;
      color: #c62828;
    }
    
    .geo-info.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <header>
    <div class="location" id="locationText">üìç Pune</div>
    <div class="title" id="mainTitle">Speak for the Streets</div>
    <div class="header-right">
      <div class="language-switcher">
        <select id="langSelect" onchange="setLanguage(this.value)">
          <option value="en">üåê English</option>
          <option value="hi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
          <option value="mr">üåø ‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
        </select>
      </div>
    </div>
  </header>

  <div class="sidebar">
    <a href="main.html"><i class="fas fa-home"></i> <span id="navHome">Home</span></a>
    <a href="create.html"><i class="fas fa-plus"></i> <span id="navCreate">Create</span></a>
    <a href="profile.html"><i class="fas fa-user"></i> <span id="navProfile">Profile</span></a>
    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span id="navLogout">Log Out</span></a>
  </div>

  <div class="main-content">
    <h2 id="createHeading">Report a Civic Issue</h2>
    <p style="color: #666; margin-bottom: 20px;">
      <i class="fas fa-info-circle"></i> <strong>Important:</strong> Photos must be taken with location services enabled to verify the issue location.
    </p>

    <form id="createComplaintForm">
      <label for="title" id="labelComplaintTitle">Complaint Title</label>
      <input type="text" id="title" required placeholder="e.g., Pothole on Main Street">
      
      <label for="category" id="labelCategory">Category</label>
      <select id="category" required>
        <option value="roads">üõ£Ô∏è Roads</option>
        <option value="garbage">üóëÔ∏è Garbage</option>
        <option value="water">üíß Water</option>
        <option value="electricity">‚ö° Electricity</option>
      </select>
      
      <label for="description" id="labelDescription">Description</label>
      <textarea id="description" rows="4" required placeholder="Describe the issue in detail..."></textarea>
      
      <label for="image" id="labelUploadImage">Upload Image <span style="color: red;">*</span></label>
      <input type="file" id="image" accept="image/*" required capture="environment">
      <small style="color: #666;">üì∏ Make sure location services are enabled when taking the photo</small>
      
      <div id="geoInfo" class="geo-info"></div>
      
      <div class="preview" id="imagePreview">
        <img src="" alt="Preview">
      </div>
      
      <button type="submit" id="btnSubmitComplaint">
        <i class="fas fa-paper-plane"></i> Submit Complaint
      </button>
      
      <div class="message" id="complaintMessage"></div>
    </form>
  </div>

  <script>
// Check authentication
const userEmail = localStorage.getItem('userEmail');
if(!userEmail){
  alert('Please login first!');
  window.location.href = 'signin.html';
}

function logout(){
  localStorage.clear();
  alert("Logging out..."); 
  window.location.href="index.html";
}

let issueLatitude = null;
let issueLongitude = null;
let hasValidGeoTag = false;

// Handle image selection and EXIF extraction
document.getElementById("image").addEventListener("change", function(e) {
  const file = e.target.files[0];
  const preview = document.querySelector("#imagePreview img");
  const geoInfo = document.getElementById('geoInfo');
  const messageDiv = document.getElementById('complaintMessage');
  
  if (file) {
    // Show preview
    preview.src = URL.createObjectURL(file);
    document.getElementById("imagePreview").style.display = "block";
    
    // Extract EXIF data
    EXIF.getData(file, function() {
      const lat = EXIF.getTag(this, 'GPSLatitude');
      const lng = EXIF.getTag(this, 'GPSLongitude');
      const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
      const lngRef = EXIF.getTag(this, 'GPSLongitudeRef');
      
      if (lat && lng) {
        // Convert GPS coordinates to decimal
        issueLatitude = convertDMSToDD(lat[0], lat[1], lat[2], latRef);
        issueLongitude = convertDMSToDD(lng[0], lng[1], lng[2], lngRef);
        hasValidGeoTag = true;
        
        geoInfo.className = 'geo-info success';
        geoInfo.style.display = 'block';
        geoInfo.innerHTML = `
          <i class="fas fa-check-circle"></i> <strong>Geo-tag verified!</strong><br>
          Location: ${issueLatitude.toFixed(6)}, ${issueLongitude.toFixed(6)}<br>
          <a href="https://www.google.com/maps?q=${issueLatitude},${issueLongitude}" target="_blank" style="color: #1976d2;">
            <i class="fas fa-map-marker-alt"></i> View on Map
          </a>
        `;
        messageDiv.innerHTML = '';
      } else {
        hasValidGeoTag = false;
        issueLatitude = null;
        issueLongitude = null;
        
        geoInfo.className = 'geo-info error';
        geoInfo.style.display = 'block';
        geoInfo.innerHTML = `
          <i class="fas fa-exclamation-triangle"></i> <strong>No location data found!</strong><br>
          This photo doesn't have GPS information. Please:<br>
          1. Enable location services on your device<br>
          2. Take a new photo at the issue location<br>
          3. Make sure your camera app has location permission
        `;
        
        messageDiv.className = 'message error';
        messageDiv.innerHTML = '‚ùå Image must have location data. Please take a new photo with location services enabled.';
      }
    });
  } else {
    document.getElementById("imagePreview").style.display = "none";
    geoInfo.style.display = 'none';
    hasValidGeoTag = false;
  }
});

// Convert DMS (Degrees, Minutes, Seconds) to Decimal Degrees
function convertDMSToDD(degrees, minutes, seconds, direction) {
  let dd = degrees + minutes/60 + seconds/3600;
  if (direction === 'S' || direction === 'W') {
    dd = dd * -1;
  }
  return dd;
}

// Get user's current location (for reference, not for the issue)
let userLatitude = null;
let userLongitude = null;

navigator.geolocation.getCurrentPosition(
  pos => {
    userLatitude = pos.coords.latitude;
    userLongitude = pos.coords.longitude;
    console.log('User location obtained:', userLatitude, userLongitude);
  }, 
  error => {
    console.warn("Could not get user location:", error);
    userLatitude = 18.5204;
    userLongitude = 73.8567;
  }
);

// COMPLAINT FORM SUBMISSION
const complaintForm = document.getElementById("createComplaintForm");
complaintForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const messageDiv = document.getElementById("complaintMessage");
  const submitBtn = complaintForm.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  
  // Validate geo-tag
  if (!hasValidGeoTag) {
    messageDiv.className = "message error";
    messageDiv.innerHTML = "‚ùå Please upload an image with location data (geo-tag). Take a new photo with location services enabled.";
    return;
  }
  
  // Disable submit button
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
  messageDiv.innerText = "Uploading complaint...";
  messageDiv.className = "message";
  
  const formData = new FormData();
  formData.append("title", document.getElementById("title").value);
  formData.append("description", document.getElementById("description").value);
  formData.append("category", document.getElementById("category").value);
  formData.append("image", document.getElementById("image").files[0]);
  formData.append("latitude", userLatitude || 18.5204); // User's location
  formData.append("longitude", userLongitude || 73.8567);
  formData.append("issueLatitude", issueLatitude); // Issue location from photo
  formData.append("issueLongitude", issueLongitude);
  formData.append("userEmail", userEmail);

  try {
    const res = await fetch("http://localhost:5000/report", { 
      method: "POST", 
      body: formData 
    });
    const data = await res.json();
    
    if (res.ok) { 
      messageDiv.innerHTML = `
        ‚úÖ ${data.message}<br>
        <small>Geo-tag verified and location recorded</small>
      `; 
      messageDiv.className = "message success"; 
      complaintForm.reset(); 
      document.getElementById("imagePreview").style.display = "none";
      document.getElementById("geoInfo").style.display = "none";
      hasValidGeoTag = false;
      
      // Redirect to main page after 2 seconds
      setTimeout(() => {
        window.location.href = 'main.html';
      }, 2000);
    } else { 
      messageDiv.innerHTML = "‚ùå " + (data.message || "Error submitting complaint"); 
      messageDiv.className = "message error";
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    }
  } catch (err) {
    console.error('Upload error:', err);
    messageDiv.innerHTML = "‚ùå Failed to connect to server. Make sure server is running on http://localhost:5000"; 
    messageDiv.className = "message error";
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
  }
});

// LANGUAGE SYSTEM
const translations = {
  en: {
    locationText: "üìç Pune, India",
    mainTitle: "Speak for the Streets",
    navHome: "Home",
    navCreate: "Create",
    navProfile: "Profile",
    navLogout: "Log Out",
    createHeading: "Report a Civic Issue",
    labelComplaintTitle: "Complaint Title",
    labelCategory: "Category",
    labelDescription: "Description",
    labelUploadImage: "Upload Image",
    btnSubmitComplaint: "Submit Complaint"
  },
  hi: {
    locationText: "üìç ‡§™‡•Å‡§£‡•á, ‡§≠‡§æ‡§∞‡§§",
    mainTitle: "‡§∏‡§°‡§º‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡•ã‡§≤‡•á‡§Ç",
    navHome: "‡§π‡•ã‡§Æ",
    navCreate: "‡§¨‡§®‡§æ‡§è‡§Å",
    navProfile: "‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤",
    navLogout: "‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü",
    createHeading: "‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç",
    labelComplaintTitle: "‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§ ‡§ï‡§æ ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï",
    labelCategory: "‡§∂‡•ç‡§∞‡•á‡§£‡•Ä",
    labelDescription: "‡§µ‡§ø‡§µ‡§∞‡§£",
    labelUploadImage: "‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
    btnSubmitComplaint: "‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç"
  },
  mr: {
    locationText: "üìç ‡§™‡•Å‡§£‡•á, ‡§≠‡§æ‡§∞‡§§",
    mainTitle: "‡§∞‡§∏‡•ç‡§§‡•ç‡§Ø‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä ‡§¨‡•ã‡§≤‡§æ",
    navHome: "‡§π‡•ã‡§Æ",
    navCreate: "‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ",
    navProfile: "‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤",
    navLogout: "‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü",
    createHeading: "‡§®‡§æ‡§ó‡§∞‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ",
    labelComplaintTitle: "‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï",
    labelCategory: "‡§∂‡•ç‡§∞‡•á‡§£‡•Ä",
    labelDescription: "‡§µ‡§∞‡•ç‡§£‡§®",
    labelUploadImage: "‡§™‡•ç‡§∞‡§§‡§ø‡§Æ‡§æ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ",
    btnSubmitComplaint: "‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§æ"
  }
};

function setLanguage(lang) {
  Object.keys(translations[lang] || {}).forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (el.tagName === 'INPUT' || el.tagName === 'BUTTON') {
        el.value = translations[lang][id];
      } else {
        el.innerText = translations[lang][id];
      }
    }
  }); 
  localStorage.setItem("preferredLanguage", lang);
}

window.onload = () => {
  const savedLang = localStorage.getItem("preferredLanguage") || "en"; 
  document.getElementById("langSelect").value = savedLang; 
  setLanguage(savedLang);
}
  </script>
</body>
</html>
